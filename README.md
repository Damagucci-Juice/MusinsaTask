# MusinsaTask

![](https://i.imgur.com/shldiJX.png)

* 작업기간
    * 2022.07.13 ~ 2022.07.17
    * 리드미 작성일 2022.07.19(기간외)
* 참여자 
    * 본인

## 앱 소개

무신사 앱의 Scene 한 부분을 모의로 만들어 보는 사전 과제입니다.

주로 사용된 기술과 라이브러리

* Swift, UIKit
* SnapKit, KingFisher, TinyNetworking

## 데모

![Simulator Screen Recording - iPhone 11 - 2022-07-19 at 16 05 20](https://user-images.githubusercontent.com/50472122/179704261-82121077-bdd9-4025-9431-c7b56bb3cbac.gif)


## 요구사항에 대한 작업 내용 

### 필수 구현 사항

 - [x] 주어진 JSON을 파싱하여 리스트를 구성한다.

### 추가 선택 구현 사항

 - [ ] 주어진 Json의 데이터가 많아져 노출된 화면의 리스트가 길어져도 자연스러운 스크롤이 되기를 원합니다.
     - 이 부분이 캐싱에 대한 요구였던 듯 하다.
 - [ ] "더보기" 버튼 터치 시 콘텐츠와 버튼 사이로 새로운 콘텐츠들이 추가됩니다.
 - [ ] "새로고침" 버튼 터치 시 노출된 콘텐츠들이 새로고침 되어 랜덤하게 변경됩니다. 



## 구성 설명

* UI
    * CollectionView Compositional Layout
    * Section 마다 다른 CustomCell 채택

* Network
    * TinyNetworking 에서 요청 마다 베이스 케이스를 추가하는 방식
    
* Image 
    * Cell 에서 kingfisher 라이브러리를 이용해 요청

## 고민과 해결

### Cell 에서 재사용성을 높이는 문제

* prepareForReuse()를 사용해도 원하는 대로 재사용이 안됨
    * 스모킹 테스트를 통해서 결과가 나올 때까지 시도
    
* **해결방법**

    * `prepareForReuse()`에서 `layoutIfNeed()`를 호출
    * `layoutIfNeed()` 에서는 쿠폰 여부에 따라 스택뷰의 하위 뷰를 추가하는 로직을 담당

### 상품 가격 정보 스택뷰에서 레이아웃 배치 문제

* 수평 스택뷰로 구성
* "가격 / 할인율 / 쿠폰" 의 순서
* 쿠폰은 가변적으로 존재해서 레이아웃이 일정하지 않았음
    * 처음에 시도는 쿠폰 레이블의 `isHidden` 메서드를 이용
    * 그러면 "가격 / 할인율 / []" 일 때의 레이아웃 배치가 이상해 보임
    * 원하는 배치
        *  "가격 / [] / 할인율" 
        *  "가격 / 할인율 / 쿠폰"

* **해결방법**
    * 상품 정보가 담긴 객체를 넘겨받을 때 `layoutIfNeed()` 를 호출
    * `hasCoupone` 속성의 값을 보고 스택뷰에 추가하는 뷰의 종류를 지정함
        * `hasCoupone` 값이 참이라면
            * "가격 / 할인율 / 쿠폰"
        * `hasCoupone` 값이 거짓이라면
            * "가격 / [] / 할인율"

    * 스택뷰의 리딩 트레일링을 가득하게 하고,
    * 할인율의 글자정렬을 오른쪽으로 지정
        
<img width="293" alt="image" src="https://user-images.githubusercontent.com/50472122/179704790-d965e08c-ff30-46d5-bab0-81a3ab3fd772.png">

### 이미지를 가져오는 로직을 누가 담당할 것인가에 대한 문제

* MVC 패턴을 채택하려고 노력

* View 영역인 Cell이 Model 역할을 하는 KingFisher를 가져도 되는지에 대한 의문
* Cell 이 KingFisher 라이브러리 코드를 가지고 있는 이유
    * Cell에 상품에 대한 정보를 넘겨주는 부분에서 KingFisher 관련 코드를 가지고 외부에서 넘겨줄 경우

    * 전체 모델에서 **가져온 이미지가 어떤 객체의 소유인지 찾는 과정이 필요함**
    * 이 부분이 자원 낭비라고 생각해서, Cell이 직접 이미지를 업데이트 하는 로직을 담당하게 함

### Header View, Footer View를 추가하는 문제

* 기존 방식으로 ReusableView를 구현하는 것에 더해 한가지 절차를 추가해줘야함.

* CollectionView Compositional Layout의 Section Layout을 생성하는 부분에서 **ReusableView** 에 대한 부분의 레이아웃을 선언해주어야함

### HeaderView 에서 이미지의 사이즈를 조정하는 문제

* 이미지를 불러와서 headerView에 담았을 때 이미지의 원본 사이즈 만큼의 크기로 자리 잡음
    * 주변의 글자 크기와 조화를 이루지 못함

    * 해결책 후보
        1. UIIamge에서 이미지의 사이즈를 조정하는 확장 메서드 구현
        2. Cell의 imageView 레이아웃을 잡을 때 그 제한을 걸어둠
    * 이 중 2번의 방식으로 채택하였다.
    * 구현 모습

        ![전](https://i.imgur.com/iB3V24L.png)

        ![후](https://i.imgur.com/Ac0uovF.png)

## 더 고민해 볼 사항

* 메모리 관리
    * 뷰 하나를 들고 있는 앱이 120MB 이상의 메모리를 사용한다.
    * 순환 참조는 일어나지 않는거 같지만, 이미지를 많이 다루니까 이 부분이 문제인 듯 하다.
    
* 이미지 캐시 처리
    * 많은 이미지를 처리하는데 매번 뷰를 재사용할 때마다, 네트워크 요청이 실행되는데, 
    이는 비효율적이며 사용자 경험을 악화시킨다.
    * 디스크 캐싱과 메모리 캐싱에 대해 학습이 필요하다.

* `FooterView`에서 새로운 추천과 더보기 로직 구현
    * 더보기 기능
        * 전체 모델 풀을 보관하는 모델과 뷰로 직접 보여지는 모델을 분리
        * 예시)
            * 전체 모델 개수 100개, 현재 보여지는 모델 4개
            * 사용자 더보기 버튼 클릭
            * 전체 모델 개수 100개, 현재 보여지는 모델 8개로 추가
    * 새로운 추천 기능
        * 전체 모델의 인덱스 순서를 셔플하는 알고리즘이 필요
